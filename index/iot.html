<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="Generator" content="EditPlus®">
  <meta name="Author" content="">
  <meta name="Keywords" content="">
  <meta name="Description" content="">
  <style type="text/css">
	body{
    background-size: 100% 100%;
    font-weight: bold;
    overflow: hidden;
    background: linear-gradient(-45deg, #17213e, #000000, #006970, #007c5f);
	background-size: 400% 400%;
	animation: gradientBG 15s ease infinite;
}@keyframes gradientBG {
	0% {
		background-position: 0% 50%;
	}
	50% {
		background-position: 100% 50%;
	}
	100% {
		background-position: 0% 50%;
	}
}
	.main{width:1024px;height:768px;position:relative;margin:auto;}
	div{border:0px solid white;margin:1px;}
	.layer{position:relative;width:100%;}
	#layer01{}
	#layer01 img{text-align: center;display: block;height: 35px;padding-top: 35px;margin: auto;}
	#layer02 > div{height:100%;float:left;position:relative;}
	.layer02-data{position: absolute;width: auto;height: 100px;color: white;top: 45px;left: 65px;}
	.layer03-panel{height:100%;position:relative;float:left;}
	.layer03-left-label{position:absolute;}
	#layer03_left_label01{top:10px;left:10px;color:white;height:20px;width:200px;font-weight: bold;}
	#layer03_left_label02{right:10px;top:10px;color:#036769;height:20px;width:200px;}
	.layer03-left-chart{position:relative;float:left;height:100%;}
	#layer03_right_label{position:absolute;top:10px;left:10px;color:white;height:20px;width:100px;}
	.layer03-right-chart{position:relative;float:left;height:100%;width:16%;}
	.layer03-right-chart-label{color: white;text-align: center;position: absolute;bottom: 60px;width: 100%;}
	.layer04-panel{position:relative;float:left;height:100%;width:48%;}
	.layer04-panel-label{width:100%;height:15%;color:white;padding-top:5px;}
	.layer04-panel-chart{width:100%;height:85%;}
  </style>
	 <link rel="stylesheet" type="text/css" href="css/dialog.css" />
  <script src="http://www.jq22.com/jquery/jquery-1.10.2.js"></script>
  <script src="https://www.jq22.com/jquery/echarts-4.2.1.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/mqtt/4.1.0/mqtt.min.js"></script>
  <script src="monitor.js"></script>
  <script src="js/dialog.min.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript">
	var MQTT_C;
	$(function(){
		drawLayer02Label($("#layer02_01 canvas").get(0),"服务器连接状态",80,200);
		drawLayer02Label($("#layer02_02 canvas").get(0),"设备在线状态",80,300);
		drawLayer02Label($("#layer02_03 canvas").get(0),"环境指标条目",80,200);
		drawLayer02Label($("#layer02_04 canvas").get(0),"接收消息总数量",80,500);
		
		// renderLegend();
		//
		// //饼状图
		// renderChartBar01();
		// //renderChartBar02();

		//存储
		renderLayer03Right();

		//30天日均线流量趋势
		renderLayer04Left("layer04_left_chart");
		renderLayer04Left("layer04_right_chart");


		$("#openDialog").dialog({
			id: "superDialog",   //必填,必须和已有id不同
			title: "服务器连接验证",   //对话框的标题 默认值: 我的标题
			type: 0, //0 对话框有确认按钮和取消按钮 1 对话框只有关闭按钮
			easyClose: true, // 点击遮罩层也可以关闭窗口,默认值false
			form: [{
				description: "用户名",
				type: "text",
				name: "username",
				value:""
			}, {
				description: "密码",
				type: "text",
				name: "password",
				value:""
			}], //form 是填充表单的数据,必填
			submit: function(data) {
				//data是表单收集的数据
				console.log(data);
				mqtt_func(data.username,data.password);
			}
		})
        setTimeout(function (){
			document.getElementById("openDialog").click();
		},1000)

		//集群性能
		// renderLayer04Right();
	});

	function mqtt_func(username,password){

		const clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8)
		const host = 'ws://muyusheng.com:1885';
		const sub_topic = 'hello_world';
		const options = {
			keepalive: 30,
			clientId: clientId,
			protocolId: 'MQTT',
			username: username,  //mqtt用户名
			password: password,  //mqtt用户密码
			protocolVersion: 4,
			clean: true,
			reconnectPeriod: 1000,
			connectTimeout: 30 * 1000,
		}
		document.getElementById("connect_status").innerHTML = "正在连接...";
		console.log('connecting mqtt client')
		MQTT_C = mqtt.connect(host, options)

		MQTT_C.on('error', function (err) {
			document.getElementById("connect_status").innerHTML = "连接失败请重试！";
			console.log(err)
			MQTT_C.end()
		})

		MQTT_C.on('connect', function () {
			console.log('client connected:' + clientId)
			MQTT_C.subscribe(sub_topic, {qos: 0})
			document.getElementById("connect_status").innerHTML = "已连接";
			// client.publish('topic', 'wss secure connection demo...!', { qos: 0, retain: false })
		})

		MQTT_C.on('message', function (topic, message, packet) {
			var message_str = 'Received topic ' + topic + ' message: ' + message.toString() + '\n';
			console.log(message_str)
		})

		MQTT_C.on('close', function () {
			document.getElementById("connect_status").innerHTML = "连接失败请重试!";
			console.log(clientId + ' disconnected')
		})


	}

  </script>
  <title>环境监控控制台</title>
 </head>
 <body>
	 <div class="main">
		 <h1 style="text-align: center;color: dodgerblue">环境监控控制台</h1>
		 <button type="button" id="openDialog" style="background: #5bc4fc">连接服务器</button>
		<div id="layer02" class="layer" style="height:15%;">
			<div id="layer02_01" style="width:22%;">
				<div class="layer02-data">
					<span style="font-size:20px;" id="connect_status">未连接</span>
				</div>
				<canvas width="250" height="100"></canvas>
			</div>
			<div id="layer02_02" style="width:22%;">
				<div class="layer02-data">
					<span style="font-size:20px;">在线</span>
				</div>
				<canvas width="200" height="100"></canvas>
			</div>
			<div id="layer02_03" style="width:22%;">
				<div class="layer02-data">
					<span style="font-size:20px;">6项</span>
				</div>
				<canvas width="200" height="100"></canvas>
			</div>
			<div id="layer02_04" style="width:25%;">
				<div class="layer02-data">
					<span style="font-size:20px;">50</span>
					<span style="font-size:16px;">条</span>
				</div>
				<canvas width="200" height="100"></canvas>
			</div>
		</div>
		<div id="layer03" class="layer" style="height:40%;">
<!--			<div id="layer03_left" style="width:48%;" class="layer03-panel">-->
<!--				<div id="layer03_left_label01" class="layer03-left-label">接入机型占比</div>-->
<!--				&lt;!&ndash;-->
<!--				<div id="layer03_left_label02" class="layer03-left-label">(左)在线数量 (右)上线率</div>-->
<!--				&ndash;&gt;-->
<!--				<div id="layer03_left_01" class="layer03-left-chart" style="width:16%;">-->
<!--					<canvas width="100" height="200" style="margin:30px 0 0 20px;"></canvas>-->
<!--				</div>-->
<!--				-->
<!--				<div id="layer03_left_02" class="layer03-left-chart" style="width:80%;"></div>-->
<!--				&lt;!&ndash;-->
<!--				<div id="layer03_left_03" class="layer03-left-chart" style="width:80%;"></div>-->
<!--				&ndash;&gt;-->
<!--			</div>-->
			<div id="layer03_right" style="width:95%;" class="layer03-panel">
				<div id="layer03_right_label">实时各项指标</div>
				<div id="layer03_right_chart01" class="layer03-right-chart">
					<canvas width="130" height="150" style="margin:40px 0 0 10px;"></canvas>
					<div class="layer03-right-chart-label">一氧化碳</div>
				</div>
				<div id="layer03_right_chart02" class="layer03-right-chart">
					<canvas width="130" height="150" style="margin:40px 0 0 10px;"></canvas>
					<div class="layer03-right-chart-label">二氧化碳</div>
				</div>
				<div id="layer03_right_chart03" class="layer03-right-chart">
					<canvas width="130" height="150" style="margin:40px 0 0 10px;"></canvas>
					<div class="layer03-right-chart-label">甲烷</div>
				</div>
				<div id="layer03_right_chart04" class="layer03-right-chart">
					<canvas width="130" height="150" style="margin:40px 0 0 10px;"></canvas>
					<div class="layer03-right-chart-label">氨气</div>
				</div>
				<div id="layer03_right_chart05" class="layer03-right-chart">
					<canvas width="130" height="150" style="margin:40px 0 0 10px;"></canvas>
					<div class="layer03-right-chart-label">温度（°C）</div>
				</div>
				<div id="layer03_right_chart06" class="layer03-right-chart">
					<canvas width="130" height="150" style="margin:40px 0 0 10px;"></canvas>
					<div class="layer03-right-chart-label">湿度（%rh）</div>
				</div>
			</div>
		</div>
		<div id="layer04" class="layer" style="height:30%;">
			<div id="layer04_left" class="layer04-panel">
				<div id="layer04_left_label" class="layer04-panel-label">一氧化碳浓度趋势</div>
				<div id="layer04_left_chart" class="layer04-panel-chart"></div>
			</div>
			<div id="layer04_right" class="layer04-panel">
				<div id="layer04_right_label" class="layer04-panel-label">二氧化碳浓度趋势</div>
				<div id="layer04_right_chart" class="layer04-panel-chart"></div>
			</div>

<!--			<div id="layer04_right" class="layer04-panel">-->
<!--				<div id="layer04_right_label" class="layer04-panel-label">-->
<!--					<span>集群性能/</span><span style="color:#00A09A;">近一个小时</span>-->
<!--				</div>-->
<!--				<div id="layer04_right_chart" class="layer04-panel-chart"></div>-->
<!--			</div>-->
		</div>
	</div>
 </body>
</html>
